function ngdbProvider(n){var t=this;t.repositoriesSchema={};var e=function(t){var e=!0;return ngdbUtils().browseObject(t,function(t){e=n[t]?e:!1}),e};return t.setRepository=function(n,r){return e(r)?(r.id="ID",t.repositoriesSchema[n]=r):ngdbUtils().errorHandler("Unable to create '"+n+"' due to unknown datatype."),t},t.$get=ngdbFactory,t}function ngdbFactory(n,t,e,r,i,a){var u=this,o={},c=function(n){var t={};return e.browseObject(n,function(n,e){t[e]="id"!==e?a[n]:"integer primary key"}),t};return o.createRepositories=function(){var t=[],i=u.repositoriesSchema;return e.browseObject(i,function(n,i){var a=[];n=c(n),e.browseObject(n,function(n,t){a.push("`"+t+"` "+n)}),t.push(r.make("CREATE TABLE IF NOT EXISTS `"+i+"` ("+a.join(", ")+")"))}),n.all(t)},o.getRepository=function(n,e){var r=t.instantiate(ngdbRepository,{ngdbQueryBuilder:t.instantiate(ngdbQueryBuilder)}),i=o.getRepositorySchema(n);return r.ngdbRepositorySetRepository(n,i,e),r},o.getRepositorySchema=function(n){return u.repositoriesSchema[n]||null},o.getQueryMaker=function(){return r},o.putWatcher=function(n,t,e){var r=i.putWatcher(n,t);return(e===!0||"undefined"==typeof e)&&i.callWatcher(n,n),r},o.popWatcher=function(n){return i.popWatcher(n)},o.createRepositories(),o}function ngdbQuery(n,t){var e=this,r=null,i=function(){return r=window.cordova?t.openDB("ngdb.db"):window.openDatabase("ngdb.db","1","ngdb.db",-1)};return e.make=function(t,e){var i=n.defer();return e=void 0!==e&&null!==e?e:[],r.transaction(function(n){n.executeSql(t,e,function(n,t){i.resolve(t)},function(n,t){i.reject(t)})}),i.promise},e.fetchAll=function(n){for(var t=[],e=n.rows.length,r=0;e>r;r++)t.push(n.rows.item(r));return t},e.fetch=function(n){return n.rows.length>0?n.rows.item(0):null},i(),e}function ngdbRepository(n,t,e,r,i,a,u){var o=this,c=!0,d=null,s=null;o.ngdbRepositorySetRepository=function(n,t,e){return d=n,s=t,c=e===!1?!1:!0,i.ngdbQueryBuilderSetRepository(n),o};var l=function(n){var t=r.fetchAll(n);return t&&t.forEach(function(n,e){t[e]=u.convertDataToGet(n,s)}),t},b=function(n){var t=u.convertDataToGet(r.fetch(n),s);return t?t:null},f=function(n){return c?void n.then(function(){a.updateCache(d)}):0};return o.get=function(){var t=n.defer(),e=this.buildQuery("SELECT"),i=a.getCache(d,e,l);if(i===!1){var u=r.make(e.query,e.binds);u.then(function(n){var r=l(n);t.resolve(r),a.putCache(d,e,l,r)},t.reject)}else t.resolve(i);return this.resetBuilder(),t.promise},o.getOne=function(){var t=n.defer(),e=this.setLimit(0,1).buildQuery("SELECT"),i=a.getCache(d,e,b);if(i===!1){var u=r.make(e.query,e.binds);u.then(function(n){var r=b(n);t.resolve(r),a.putCache(d,e,b,r)},t.reject)}else t.resolve(i);return this.resetBuilder(),t.promise},o.add=function(n){n=u.convertDataToAdd(n,s);var t=this.buildQuery("INSERT",n),e=r.make(t.query,t.binds);return f(e),this.resetBuilder(),e},o.update=function(n){n=u.convertDataToAdd(n,s);var t=this.buildQuery("UPDATE",n),e=r.make(t.query,t.binds);return f(e),this.resetBuilder(),e},o.delete=function(){var n=this.buildQuery("DELETE"),t=r.make(n.query,n.binds);return f(t),this.resetBuilder(),t},angular.extend(o,i),o}function ngdbCache(n,t){var e=this,r={},i=[],a=function(n,t){return t&&t.forEach(function(e,r){n[r]=t[r]}),n&&n.forEach(function(e,r){t[r]||n.pop()}),n},u=function(n,e){return e&&t.browseObject(e,function(t,e){n[e]=t}),n&&t.browseObject(n,function(t,r){e&&e[r]||delete n[r]}),n},o=function(n,t){return t instanceof Array?a(n,t):t instanceof Object?u(n,t):u(n,t)},c=function(n){var t=!1;return i.some(function(e){return e.value===n&&(t=e)}),t===!1?!1:t};return e.getCache=function(n,t,e){var i=r[n],a=e.toString(),u=JSON.stringify(t),o=!1;return i&&i.some(function(n){var t=n.dataFormater.toString(),e=JSON.stringify(n.query);return e===u&&t===a&&(o=n)}),o===!1?!1:o.value},e.putCache=function(n,t,e,i){return n&&t&&e&&i?(r[n]=r[n]?r[n]:[],void r[n].push({query:t,value:i,dataFormater:e})):0},e.updateCache=function(t){var i=r[t];i&&i.forEach(function(t){var r=n.make(t.query.query,t.query.binds);r.then(function(n){var r=t.dataFormater.call(null,n),i=angular.copy(t.value);angular.equals(r,i)||(o(t.value,r),e.callWatcher(t.value,i))})})},e.putWatcher=function(n,t){var r=c(n);return this.watcherId=this.watcherId||0,r?(r.callbacks.push({id:++this.watcherId,callback:t}),this.watcherId):(i.push({value:n,callbacks:[]}),e.putWatcher(n,t))},e.popWatcher=function(n){var t=!1;return i.some(function(e,r){var a=e.callbacks.some(function(e,r){return e.id===n&&(t=r)});return a&&delete i[r].callbacks[t]}),!(t===!1)},e.callWatcher=function(n,t){var e=c(n);e&&e.callbacks.forEach(function(e){e.callback(n,t)})},e}function ngdbDataConverter(n){var t=this,e=function(n){var t=null;try{t=angular.fromJson(n)}catch(e){return!1}return t},r=function(n){return angular.isObject(n)&&Object.keys(n).length&&angular.toJson(n)||void 0},i=function(n){return angular.isObject(n)&&n.length&&angular.toJson(n)||void 0},a=function(n){return e(n)||void 0},u=function(n){return n instanceof Date&&n.getTime()||void 0},o=function(n){return isFinite(n)&&new Date(n)||void 0},c=function(n){return isFinite(n)&&parseInt(n,10)||void 0},d=function(n){return isFinite(n)&&parseInt(n,10)||void 0},s=function(n){return n===!0||n===!1?n.toString():void 0},l=function(n){return"true"===n?!0:!1},b=function(n,t){var e={OBJECT:r,ARRAY:i,DATE:u,BOOLEAN:s,NUMBER:c};return e[t]?e[t].call(null,n):n},f=function(n,t){var e={OBJECT:a,ARRAY:a,DATE:o,BOOLEAN:l,NUMBER:d};return e[t]?e[t].call(null,n):n},g=function(t,e,r){var i=t?{}:null;return n.browseObject(t,function(n,t){if(e&&e[t]){var a=r(n,e[t]);void 0!==a&&(i[t]=a)}}),i};return t.convertDataToAdd=function(n,t){return g(n,t,b)},t.convertDataToGet=function(n,t){return g(n,t,f)},t}function ngdbQueryBuilder(n){var t=this,e={data:{matching:[],binds:[]},where:{matching:[],binds:[]},order:{matching:[],binds:[]},limit:{matching:[]},table:null},r=function(){return"SELECT * FROM `"+e.table+"`"},i=function(){var n=e.data.matching.map(function(n){return"`"+n+"` = ?"});return"UPDATE `"+e.table+"` SET "+n.join(",")},a=function(){var n=e.data.matching.map(function(){return"?"});return"INSERT INTO `"+e.table+"` (`"+e.data.matching.join("`, `")+"`) VALUES ("+n.join(",")+")"},u=function(){return"DELETE FROM `"+e.table+"`"},o=function(){var n=e.where.matching.map(function(n){return"`"+n+"` = ?"});return"WHERE "+n.join(" and ")},c=function(){return"ORDER BY "+e.order.matching.join(",")},d=function(){return"LIMIT "+e.limit.matching[0]+","+e.limit.matching[1]},s=function(){var t=[],r={where:o,order:c,limit:d};return n.browseObject(e,function(n,e){n.matching&&n.matching.length&&"data"!==e&&t.push(r[e].call())}),t.join(" ")};return t.ngdbQueryBuilderSetRepository=function(n){return e.table=n,this},t.setData=function(t){n.browseObject(t,function(n,t){e.data.matching.push(t),e.data.binds.push(n)})},t.buildQuery=function(o,c){var d={SELECT:r,UPDATE:i,INSERT:a,DELETE:u};t.setData(c);var l=d[o].call()+" "+s(),b=[];return n.browseObject(e,function(n){n.binds&&n.binds.length&&(b=b.concat(n.binds))}),{query:l,binds:b}},t.resetBuilder=function(){e={data:{matching:[],binds:[]},where:{matching:[],binds:[]},order:{matching:[],binds:[]},limit:{matching:[]},table:e.table}},t.setBy=function(t){return n.browseObject(t,function(n,t){e.where.matching.push(t),e.where.binds.push(n)}),this},t.setOrder=function(t){return n.browseObject(t,function(n,t){e.order.matching.push(t+" "+n)}),this},t.setLimit=function(n,t){return e.limit.matching[0]=parseInt(n,10),e.limit.matching[1]=parseInt(t,10),this},t}function ngdbUtils(){var n=this;return n.browseObject=function(n,t){for(var e in n){var r=n[e];void 0!==r&&null!==r&&t(r,e)}},n.errorHandler=function(n){throw new Error("NGDB : "+n,"","")},n}angular.module("ngDatabase",["ngCordova"]).constant("NGDB_TYPES",{ID:"integer",STRING:"text",NUMBER:"integer",BOOLEAN:"text",OBJECT:"text",ARRAY:"text",DATE:"datetime"}),angular.module("ngDatabase").provider("ngdb",ngdbProvider),ngdbProvider.$inject=["NGDB_TYPES"],ngdbFactory.$inject=["$q","$injector","ngdbUtils","ngdbQuery","ngdbCache","NGDB_TYPES"],angular.module("ngDatabase").factory("ngdbQuery",ngdbQuery),ngdbQuery.$inject=["$q","$cordovaSQLite"],angular.module("ngDatabase").service("ngdbRepository",ngdbRepository),ngdbRepository.$inject=["$q","$injector","ngdbUtils","ngdbQuery","ngdbQueryBuilder","ngdbCache","ngdbDataConverter"],angular.module("ngDatabase").factory("ngdbCache",ngdbCache),ngdbCache.$inject=["ngdbQuery","ngdbUtils"],angular.module("ngDatabase").factory("ngdbDataConverter",ngdbDataConverter),ngdbDataConverter.$inject=["ngdbUtils"],angular.module("ngDatabase").service("ngdbQueryBuilder",ngdbQueryBuilder),ngdbQueryBuilder.$inject=["ngdbUtils"],angular.module("ngDatabase").factory("ngdbUtils",ngdbUtils),ngdbUtils.$inject=[];