function ngdbProvider(n){var t=this;return t.repositorySchema={},t.setRepository=function(e,r){var a=!0;return ngdbUtils().browseObject(r,function(t){a=n[t]?a:!1}),a?t.repositorySchema[e]=r:ngdbUtils().errorHandler("Unable to create '"+e+"' due to unknown datatype."),t},t.$get=ngdbFactory,t}function ngdbFactory(n,t,e,r,a,i){var u=this,o={};return o.createRepositories=function(){var t=[],a=u.repositorySchema;return e.browseObject(a,function(n,a){var u=[];e.browseObject(n,function(n,t){u.push(t+" "+i[n])}),t.push(r.make("CREATE TABLE IF NOT EXISTS "+a+" ("+u.join(", ")+")"))}),n.all(t)},o.getRepository=function(n){var e=t.instantiate(ngdbRepository,{ngdbQueryBuilder:t.instantiate(ngdbQueryBuilder)}),r=u.repositorySchema[n];return e.ngdbRepositorySetRepository(n,r),e},o.getRepositorySchema=function(n){return u.repositorySchema[n]||null},o.getQueryMaker=function(){return r},o.putWatcher=function(n,t,e){var r=a.putWatcher(n,t);return(e===!0||"undefined"==typeof e)&&a.callWatcher(n,n),r},o.popWatcher=function(n){return a.popWatcher(n)},o.createRepositories(),o}function ngdbQuery(n,t){var e=this,r=null,a=function(){return r=window.cordova?t.openDB("ngdb.db"):window.openDatabase("ngdb.db","1","ngdb.db",-1)};return e.make=function(t,e){var a=n.defer();return e=void 0!==e&&null!==e?e:[],r.transaction(function(n){n.executeSql(t,e,function(n,t){a.resolve(t)},function(n,t){a.reject(t)})}),a.promise},e.fetchAll=function(n){for(var t=[],e=n.rows.length,r=0;e>r;r++)t.push(n.rows.item(r));return t},e.fetch=function(n){return n.rows.length>0?n.rows.item(0):null},a(),e}function ngdbRepository(n,t,e,r,a,i,u){var o=this,c=null,l=null;o.ngdbRepositorySetRepository=function(n,t){return c=n,l=t,a.ngdbQueryBuilderSetRepository(n),o};var d=function(n){var t=r.fetchAll(n);return t&&t.forEach(function(n,e){t[e]=u.convertDataToGet(n,l)}),t},s=function(n){var t=u.convertDataToGet(r.fetch(n),l);return t?t:null};return o.get=function(){var t=n.defer(),e=this.buildQuery("SELECT"),a=i.getCache(c,e,d);if(a===!1){var u=r.make(e.query,e.binds);u.then(function(n){var r=d(n);t.resolve(r),i.putCache(c,e,d,r)},t.reject)}else t.resolve(a);return this.resetBuilder(),t.promise},o.getOne=function(){var t=n.defer(),e=this.setLimit(0,1).buildQuery("SELECT"),a=i.getCache(c,e,s);if(a===!1){var u=r.make(e.query,e.binds);u.then(function(n){var r=s(n);t.resolve(r),i.putCache(c,e,s,r)},t.reject)}else t.resolve(a);return this.resetBuilder(),t.promise},o.add=function(n){n=u.convertDataToAdd(n,l);var t=this.buildQuery("INSERT",n),e=r.make(t.query,t.binds);return i.updateCache(c),this.resetBuilder(),e},o.update=function(n){n=u.convertDataToAdd(n,l);var t=this.buildQuery("UPDATE",n),e=r.make(t.query,t.binds);return i.updateCache(c),this.resetBuilder(),e},o.delete=function(){var n=this.buildQuery("DELETE"),t=r.make(n.query,n.binds);return i.updateCache(c),this.resetBuilder(),t},angular.extend(o,a),o}function ngdbCache(n,t){var e=this,r={},a=[],i=function(n,t){return t&&t.forEach(function(e,r){n[r]=t[r]}),n&&n.forEach(function(e,r){t[r]||n.pop()}),n},u=function(n,e){return e&&t.browseObject(e,function(t,e){n[e]=t}),n&&t.browseObject(n,function(t,r){e&&e[r]||delete n[r]}),n},o=function(n,t){return t instanceof Array?i(n,t):t instanceof Object?u(n,t):u(n,t)},c=function(n){var t=!1;return a.some(function(e){return e.value===n&&(t=e)}),t===!1?!1:t};return e.getCache=function(n,t,e){var a=r[n],i=e.toString(),u=JSON.stringify(t),o=!1;return a&&a.some(function(n){var t=n.dataFormater.toString(),e=JSON.stringify(n.query);return e===u&&t===i&&(o=n)}),o===!1?!1:o.value},e.putCache=function(n,t,e,a){return n&&t&&e&&a?(r[n]=r[n]?r[n]:[],void r[n].push({query:t,value:a,dataFormater:e})):0},e.updateCache=function(t){var a=r[t];a&&a.forEach(function(t){var r=n.make(t.query.query,t.query.binds);r.then(function(n){var r=t.dataFormater.call(null,n),a=angular.copy(t.value);o(t.value,r),e.callWatcher(t.value,a)})})},e.putWatcher=function(n,t){var r=c(n);return this.watcherId=this.watcherId||0,r?(r.callbacks.push({id:++this.watcherId,callback:t}),this.watcherId):(a.push({value:n,callbacks:[]}),e.putWatcher(n,t))},e.popWatcher=function(n){var t=!1;return a.some(function(e,r){var i=e.callbacks.some(function(e,r){return e.id===n&&(t=r)});return i&&delete a[r].callbacks[t]}),!(t===!1)},e.callWatcher=function(n,t){var e=c(n);e&&e.callbacks.forEach(function(e){e.callback(n,t)})},e}function ngdbDataConverter(n){var t=this,e=function(n){var t=null;try{t=angular.fromJson(n)}catch(e){return!1}return t},r=function(n){return angular.isObject(n)&&angular.toJson(n)||null},a=function(n){return e(n)||null},i=function(n){return n instanceof Date&&n.getTime()||null},u=function(n){return isFinite(n)&&new Date(n)||null},o=function(n){return isFinite(n)&&parseInt(n,10)||null},c=function(n){return isFinite(n)&&parseInt(n,10)||null},l=function(n){return n===!0?!0:!1},d=function(n){return"true"===n?!0:!1},s=function(n,t){var e={OBJECT:r,ARRAY:r,DATE:i,BOOLEAN:l,NUMBER:o};return e[t]?e[t].call(null,n):n},b=function(n,t){var e={OBJECT:a,ARRAY:a,DATE:u,BOOLEAN:d,NUMBER:c};return e[t]?e[t].call(null,n):n},f=function(t,e,r){var a=t?{}:null;return n.browseObject(t,function(n,t){e&&e[t]&&(a[t]=r(n,e[t]))}),a};return t.convertDataToAdd=function(n,t){return f(n,t,s)},t.convertDataToGet=function(n,t){return f(n,t,b)},t}function ngdbQueryBuilder(n){var t=this,e={data:{matching:[],binds:[]},where:{matching:[],binds:[]},order:{matching:[],binds:[]},limit:{matching:[]},table:null},r=function(){return"SELECT * FROM "+e.table},a=function(){var n=e.data.matching.map(function(n){return n+" = ?"});return"UPDATE "+e.table+" SET "+n.join(",")},i=function(){var n=e.data.matching.map(function(){return"?"});return"INSERT INTO "+e.table+" ("+e.data.matching.join(",")+") VALUES ("+n.join(",")+")"},u=function(){return"DELETE FROM "+e.table},o=function(){var n=e.where.matching.map(function(n){return n+" = ?"});return"WHERE "+n.join(" and ")},c=function(){return"ORDER BY "+e.order.matching.join(",")},l=function(){return"LIMIT "+e.limit.matching[0]+","+e.limit.matching[1]},d=function(){var t=[],r={where:o,order:c,limit:l};return n.browseObject(e,function(n,e){n.matching&&n.matching.length&&"data"!==e&&t.push(r[e].call())}),t.join(" ")};return t.ngdbQueryBuilderSetRepository=function(n){return e.table=n,this},t.setData=function(t){n.browseObject(t,function(n,t){e.data.matching.push(t),e.data.binds.push(n)})},t.buildQuery=function(o,c){var l={SELECT:r,UPDATE:a,INSERT:i,DELETE:u};t.setData(c);var s=l[o].call()+" "+d(),b=[];return n.browseObject(e,function(n){n.binds&&n.binds.length&&(b=b.concat(n.binds))}),{query:s,binds:b}},t.resetBuilder=function(){e={data:{matching:[],binds:[]},where:{matching:[],binds:[]},order:{matching:[],binds:[]},limit:{matching:[]},table:e.table}},t.setBy=function(t){return n.browseObject(t,function(n,t){e.where.matching.push(t),e.where.binds.push(n)}),this},t.setOrder=function(t){return n.browseObject(t,function(n,t){e.order.matching.push(t+" "+n)}),this},t.setLimit=function(n,t){return e.limit.matching[0]=parseInt(n,10),e.limit.matching[1]=parseInt(t,10),this},t}function ngdbUtils(){var n=this;return n.browseObject=function(n,t){for(var e in n){var r=n[e];void 0!==r&&null!==r&&t(r,e)}},n.errorHandler=function(n){throw new Error("NGDB : "+n,"","")},n}angular.module("ngDatabase",["ngCordova"]).constant("NGDB_TYPES",{ID:"integer primary key",STRING:"text",NUMBER:"integer",BOOLEAN:"boolean",OBJECT:"text",ARRAY:"text",DATE:"datetime"}),angular.module("ngDatabase").provider("ngdb",ngdbProvider),ngdbProvider.$inject=["NGDB_TYPES"],ngdbFactory.$inject=["$q","$injector","ngdbUtils","ngdbQuery","ngdbCache","NGDB_TYPES"],angular.module("ngDatabase").factory("ngdbQuery",ngdbQuery),ngdbQuery.$inject=["$q","$cordovaSQLite"],angular.module("ngDatabase").service("ngdbRepository",ngdbRepository),ngdbRepository.$inject=["$q","$injector","ngdbUtils","ngdbQuery","ngdbQueryBuilder","ngdbCache","ngdbDataConverter"],angular.module("ngDatabase").factory("ngdbCache",ngdbCache),ngdbCache.$inject=["ngdbQuery","ngdbUtils"],angular.module("ngDatabase").factory("ngdbDataConverter",ngdbDataConverter),ngdbDataConverter.$inject=["ngdbUtils"],angular.module("ngDatabase").service("ngdbQueryBuilder",ngdbQueryBuilder),ngdbQueryBuilder.$inject=["ngdbUtils"],angular.module("ngDatabase").factory("ngdbUtils",ngdbUtils),ngdbUtils.$inject=[];